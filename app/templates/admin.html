{% extends "base.html" %}

{% block title %}Admin Dashboard - ConfAI{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}?v={{ cache_buster }}">
<script src="https://unpkg.com/lucide@latest"></script>
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Header with Tabs -->
    <div class="admin-header">
        <div class="header-left">
            <a href="/chat" class="btn btn-secondary btn-back">
                <i data-lucide="arrow-left"></i>
            </a>
            <h1>Admin Dashboard</h1>
        </div>
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="switchTab('context-files')">
                <i data-lucide="folder-open"></i>
                <span>Context</span>
            </button>
            <button class="tab-btn" onclick="switchTab('insights')">
                <i data-lucide="lightbulb"></i>
                <span>Insights</span>
            </button>
            <button class="tab-btn" onclick="switchTab('statistics')">
                <i data-lucide="bar-chart-3"></i>
                <span>Statistics</span>
            </button>
            <button class="tab-btn" onclick="switchTab('settings')">
                <i data-lucide="sliders"></i>
                <span>Settings</span>
            </button>
            <button class="tab-btn" onclick="switchTab('users')">
                <i data-lucide="users"></i>
                <span>Users</span>
            </button>
        </div>
    </div>

    <!-- Tab: Context -->
    <div id="context-files" class="tab-content active">
        <!-- Hidden file input -->
        <input type="file" id="context-file-input" accept=".txt,.md" multiple hidden>
        <input type="hidden" id="upload-target" value="vectorized:background_info">

        <!-- Two Column Layout: Base Context + Vectorized Files -->
        <div class="context-two-column">
            <!-- Left: Base Context -->
            <div class="context-column">
                <div class="section-card">
                    <div class="section-header-with-stats">
                        <div>
                            <h2><i data-lucide="file-text"></i> Base Context</h2>
                            <p class="help-text">Base Content is fully included in LLM context with every user message</p>
                        </div>
                        <div class="embeddings-stats-inline">
                            <div class="stat-badge stat-badge-purple">
                                <i data-lucide="text"></i>
                                <span id="base-context-chars">0</span> chars
                            </div>
                            <div class="stat-badge stat-badge-indigo">
                                <i data-lucide="hash"></i>
                                <span id="base-context-tokens">0</span> tokens
                            </div>
                        </div>
                    </div>
                    <div class="file-column-list" id="base-context-list">
                        <div class="empty-state-small">
                            <i data-lucide="file-plus"></i>
                            <p>No base context files</p>
                            <small>Drag files here or upload</small>
                        </div>
                    </div>
                    <div class="file-column-footer">
                        <button class="btn btn-secondary btn-block" onclick="uploadToTarget('base_context')">
                            <i data-lucide="upload"></i>
                            <span>Add to Base Context</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right: Vectorized Files -->
            <div class="context-column">
                <div class="section-card">
                    <div class="section-header-with-stats">
                        <div>
                            <h2><i data-lucide="database"></i> Vectorized Files</h2>
                            <p class="help-text">Relevant chunks retrieved via semantic search and added to LLM context</p>
                        </div>
                        <div class="embeddings-stats-inline">
                            <div class="stat-badge stat-badge-success">
                                <i data-lucide="file"></i>
                                <span id="vector-doc-count">0</span> docs
                            </div>
                            <div class="stat-badge stat-badge-info">
                                <i data-lucide="layers"></i>
                                <span id="vector-chunk-count">0</span> chunks
                            </div>
                        </div>
                    </div>
                    <div class="file-column-list" id="vectorized-files-list">
                        <div class="empty-state-small">
                            <i data-lucide="database"></i>
                            <p>No vectorized files</p>
                            <small>Drag files here or upload</small>
                        </div>
                    </div>
                    <div class="file-column-footer">
                        <button class="btn btn-secondary" onclick="uploadToTarget('vectorized:background_info')">
                            <i data-lucide="upload"></i>
                            <span>Add File for Vectorization</span>
                        </button>
                        <button id="process-embeddings-btn" class="btn btn-primary" onclick="processEmbeddings()">
                            <i data-lucide="play" id="process-embeddings-icon"></i>
                            <span id="process-embeddings-text">Process</span>
                        </button>
                    </div>
                    <div id="embeddings-status" class="status-message" style="display: none; margin-top: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- File Preview Dialog -->
        <div id="file-preview-dialog" class="preview-dialog-overlay">
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3><span id="preview-dialog-filename">-</span></h3>
                    <div class="dialog-header-actions">
                        <button class="btn btn-sm btn-primary" onclick="summarizePreviewFile()" title="Generate multi-model summary using all available models">
                            <i data-lucide="sparkles"></i>
                            <span>Create Multi-Model Summary</span>
                        </button>
                        <button class="dialog-close" onclick="closeFilePreview()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                </div>
                <div class="dialog-body">
                    <pre id="preview-dialog-content"></pre>
                </div>
                <div class="dialog-footer">
                    <div class="dialog-footer-info">
                        <span id="preview-dialog-size">-</span> |
                        <span id="preview-dialog-chars">-</span> characters |
                        <span id="preview-dialog-tokens">-</span> tokens
                    </div>
                    <div class="dialog-footer-actions">
                        <button class="btn btn-secondary" onclick="downloadPreviewFile()" title="Download file">
                            <i data-lucide="download"></i>
                            <span>Download</span>
                        </button>
                        <button class="btn btn-secondary" onclick="closeFilePreview()">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summarization Progress Dialog -->
        <div id="summarization-progress-dialog" class="preview-dialog-overlay">
            <div class="dialog-container" style="max-width: 900px;">
                <div class="dialog-header">
                    <h3>Multi-Model Summarization Progress</h3>
                    <div class="dialog-header-actions">
                        <div id="summary-status-indicator" class="status-indicator">
                            <div class="spinner"></div>
                            <span id="summary-status-text">Initializing...</span>
                        </div>
                        <button class="dialog-close" onclick="closeSummarizationProgress()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                </div>
                <div class="dialog-body">
                    <textarea id="summarization-progress-log" readonly style="width: 100%; height: 500px; font-family: monospace; font-size: 13px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                </div>
                <div class="dialog-footer">
                    <button class="btn btn-secondary" onclick="closeSummarizationProgress()">Close</button>
                </div>
            </div>
        </div>

        <!-- Instructions Section -->
        <div class="section-card">
            <h2><i data-lucide="message-square"></i> Instructions</h2>
            <p class="help-text">Configure the system instructions sent to the AI with every conversation, or use quick templates.</p>

            <div class="form-group">
                <label for="base-instructions">Base Instructions</label>
                <textarea id="base-instructions" rows="8" placeholder="Loading..."></textarea>
                <div class="char-count">
                    <span id="base-chars">0</span> characters
                </div>
            </div>

            <div class="form-group">
                <label for="safety-instructions">Safety Instructions</label>
                <textarea id="safety-instructions" rows="4" placeholder="Loading..."></textarea>
                <div class="char-count">
                    <span id="safety-chars">0</span> characters
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="saveSystemPrompt()">
                    <i data-lucide="save"></i>
                    <span>Save Changes</span>
                </button>
                <button class="btn btn-secondary" onclick="resetSystemPrompt()">
                    <i data-lucide="rotate-ccw"></i>
                    <span>Reset to Default</span>
                </button>
                <button class="btn btn-info" onclick="testSystemPrompt()">
                    <i data-lucide="flask-conical"></i>
                    <span>Test Prompt</span>
                </button>
            </div>

            <div id="prompt-status" class="status-message"></div>

            <!-- Quick Templates -->
            <div style="margin-top: 30px;">
                <h3>Quick Templates</h3>
                <div class="template-grid">
                    <button class="template-btn" onclick="loadTemplate('current')">
                        <i data-lucide="database"></i>
                        <span>Current</span>
                    </button>
                    <button class="template-btn" onclick="loadTemplate('conference')">
                        <i data-lucide="presentation"></i>
                        <span>Conference Expert</span>
                    </button>
                    <button class="template-btn" onclick="loadTemplate('helpful')">
                        <i data-lucide="heart-handshake"></i>
                        <span>Helpful Assistant</span>
                    </button>
                    <button class="template-btn" onclick="loadTemplate('concise')">
                        <i data-lucide="zap"></i>
                        <span>Concise Responder</span>
                    </button>
                    <button class="template-btn" onclick="loadTemplate('creative')">
                        <i data-lucide="sparkles"></i>
                        <span>Creative Thinker</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Insights Management -->
    <div id="insights" class="tab-content">
        <div class="section-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div>
                    <h2 style="margin-bottom: 8px;">Shared Insights Management</h2>
                    <p class="help-text">Manage user-shared insights from the Insights Wall. You can delete inappropriate or duplicate content.</p>
                </div>
                <button class="btn btn-primary" onclick="exportInsights()" style="height: fit-content;">
                    <i data-lucide="download"></i>
                    <span>Export to Markdown</span>
                </button>
            </div>

            <div class="insights-section">
                <div id="admin-insights-loading" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading insights...</p>
                </div>

                <div id="admin-insights-list" style="display: none;">
                    <!-- Insights will be loaded here -->
                </div>

                <div id="admin-insights-empty" style="display: none;" class="empty-state">
                    <p>No insights have been shared yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Statistics -->
    <div id="statistics" class="tab-content">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="users"></i></div>
                <div class="stat-value" id="stat-users">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="message-circle"></i></div>
                <div class="stat-value" id="stat-threads">0</div>
                <div class="stat-label">Chat Threads</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="lightbulb"></i></div>
                <div class="stat-value" id="stat-insights">0</div>
                <div class="stat-label">Shared Insights</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="thumbs-up"></i></div>
                <div class="stat-value" id="stat-votes">0</div>
                <div class="stat-label">Total Votes Cast</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="arrow-up-circle"></i></div>
                <div class="stat-value" id="stat-tokens-sent">0</div>
                <div class="stat-label">Tokens Sent</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="arrow-down-circle"></i></div>
                <div class="stat-value" id="stat-tokens-received">0</div>
                <div class="stat-label">Tokens Received</div>
            </div>
        </div>

        <!-- Token Usage by Model -->
        <div class="section-card">
            <h3>Token Usage by Model</h3>
            <div id="token-by-model" class="token-model-grid">
                <!-- Model token stats will be loaded here -->
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="section-card">
            <h3>Recent Activity</h3>
            <div class="activity-filters">
                <button class="filter-btn active" data-filter="all" onclick="filterActivity('all')">All</button>
                <button class="filter-btn" data-filter="thread_created" onclick="filterActivity('thread_created')">Conversations</button>
                <button class="filter-btn" data-filter="insight_shared" onclick="filterActivity('insight_shared')">Shares</button>
                <button class="filter-btn" data-filter="vote_cast" onclick="filterActivity('vote_cast')">Votes</button>
            </div>
            <div id="recent-activity" class="activity-list">
                <!-- Activity items will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Tab: Settings -->
    <div id="settings" class="tab-content">
        <div class="section-card">
            <h3>Welcome Message</h3>
            <p class="help-text">This message is shown to users when they first open the chat (before creating their first conversation). Supports markdown.</p>
            <div class="form-group">
                <label for="welcome-message">Welcome Message</label>
                <textarea id="welcome-message" rows="8" placeholder="Loading..."></textarea>
                <div class="char-count">
                    <span id="welcome-chars">0</span> characters
                </div>
            </div>
        </div>

        <div class="section-card">
            <h3>New Chat Instructions</h3>
            <p class="help-text">This message is shown when a new chat is created. It appears above the conversation starters in an empty chat. Supports markdown.</p>
            <div class="form-group">
                <label for="new-chat-text">New Chat Instructions</label>
                <textarea id="new-chat-text" rows="6" placeholder="Loading..."></textarea>
                <div class="char-count">
                    <span id="new-chat-chars">0</span> characters
                </div>
            </div>
        </div>

        <div class="section-card">
            <h3>Conversation Starters</h3>
            <p class="help-text">These prompts are shown above the input when starting a new conversation. Users can click them to quickly begin a chat.</p>
            <div class="form-group">
                <label for="starter-1">Starter 1</label>
                <input type="text" id="starter-1" placeholder="Enter first conversation starter...">
            </div>
            <div class="form-group">
                <label for="starter-2">Starter 2</label>
                <input type="text" id="starter-2" placeholder="Enter second conversation starter...">
            </div>
            <div class="form-group">
                <label for="starter-3">Starter 3</label>
                <input type="text" id="starter-3" placeholder="Enter third conversation starter...">
            </div>
            <div class="form-group">
                <label for="starter-4">Starter 4</label>
                <input type="text" id="starter-4" placeholder="Enter fourth conversation starter...">
            </div>
        </div>

        <div class="section-card">
            <h3>LLM Configuration</h3>
            <div class="form-group">
                <label for="llm-provider">Default LLM Provider</label>
                <select id="llm-provider">
                    <option value="claude">Claude (Anthropic)</option>
                    <option value="gemini">Gemini (Google)</option>
                    <option value="grok">Grok (xAI)</option>
                    <option value="perplexity">Perplexity</option>
                </select>
            </div>
            <div class="form-group">
                <label for="max-tokens">Max Tokens per Response</label>
                <input type="number" id="max-tokens" value="2048" min="256" max="8192">
            </div>
        </div>

        <div class="section-card">
            <h3>Model Names</h3>
            <p class="help-text">Configure the specific model names/IDs for each provider. Update these when new models are released.</p>
            <div class="form-group">
                <label for="claude-model">Claude Model</label>
                <input type="text" id="claude-model" placeholder="claude-sonnet-4-5-20250929">
                <small class="help-text">Anthropic Claude model identifier</small>
            </div>
            <div class="form-group">
                <label for="gemini-model">Gemini Model</label>
                <input type="text" id="gemini-model" placeholder="gemini-2.5-flash-lite">
                <small class="help-text">Google Gemini model identifier</small>
            </div>
            <div class="form-group">
                <label for="grok-model">Grok Model</label>
                <input type="text" id="grok-model" placeholder="grok-4-fast-reasoning">
                <small class="help-text">xAI Grok model identifier</small>
            </div>
            <div class="form-group">
                <label for="perplexity-model">Perplexity Model</label>
                <input type="text" id="perplexity-model" placeholder="sonar">
                <small class="help-text">Perplexity model identifier</small>
            </div>
        </div>

        <div class="section-card">
            <h3>Rate Limiting</h3>
            <div class="form-group">
                <label for="rate-limit">Requests per Minute</label>
                <input type="number" id="rate-limit" value="200" min="10" max="1000">
            </div>
        </div>

        <div class="section-card">
            <h3>Insights Wall Header</h3>
            <p class="help-text">This message appears at the top of the Insights Wall. Use it to provide context, instructions, or encourage participation. Supports markdown.</p>
            <div class="form-group">
                <label for="insights-header-message">Header Message</label>
                <textarea id="insights-header-message" rows="6" placeholder="Enter a message to display at the top of the Insights Wall..."></textarea>
                <div class="char-count">
                    <span id="insights-header-chars">0</span> characters
                </div>
            </div>
        </div>

        <div class="section-card">
            <h3>Insights Limits</h3>
            <div class="form-group">
                <label for="votes-per-user">Votes per User</label>
                <input type="number" id="votes-per-user" value="3" min="1" max="10">
            </div>
            <div class="form-group">
                <label for="shares-per-user">Shares per User</label>
                <input type="number" id="shares-per-user" value="3" min="1" max="10">
            </div>
        </div>

        <div class="section-card">
            <h3>Vector Embeddings</h3>
            <p class="help-text">Configure how context files are chunked and retrieved in vector embeddings mode.</p>

            <div class="form-group">
                <label>Embedding Provider</label>
                <div class="embedding-info-box">
                    <div><strong>Provider:</strong> Google Gemini API</div>
                    <div><strong>Model:</strong> text-embedding-004</div>
                    <div><strong>Dimensions:</strong> 768</div>
                    <div><strong>Multilingual:</strong> Yes (100+ languages including Hungarian)</div>
                    <div><strong>Cost:</strong> Free (1500 requests/day)</div>
                </div>
                <small class="help-text">Requires GEMINI_API_KEY configured in .env file</small>
            </div>

            <div class="form-group">
                <label for="chunk-size">Chunk Size (characters)</label>
                <input type="number" id="chunk-size" value="1000" min="200" max="4000" step="100">
                <small class="help-text">Size of each text chunk for semantic search (200-4000 chars)</small>
            </div>
            <div class="form-group">
                <label for="chunk-overlap">Chunk Overlap (characters)</label>
                <input type="number" id="chunk-overlap" value="200" min="0" max="500" step="50">
                <small class="help-text">Overlap between consecutive chunks to preserve context (0-500 chars)</small>
            </div>
            <div class="form-group">
                <label for="chunks-to-retrieve">Chunks to Retrieve</label>
                <input type="number" id="chunks-to-retrieve" value="5" min="1" max="20">
                <small class="help-text">Number of most relevant chunks to include in each query (1-20)</small>
            </div>
        </div>

        <div class="section-card">
            <h3>Summarization</h3>
            <p class="help-text">Configure the prompts used for multi-model summarization.</p>

            <div class="form-group">
                <label for="summarize-prompt">Individual Model Prompt</label>
                <textarea id="summarize-prompt" rows="6" placeholder="Enter the prompt template for individual summaries..."></textarea>
                <small class="help-text">This prompt is sent to each model (Claude, Gemini, Grok, Perplexity) with the file content appended.</small>
                <div class="char-count">
                    <span id="summarize-prompt-chars">0</span> characters
                </div>
            </div>

            <div class="form-group">
                <label for="synthesis-prompt">Synthesis Prompt (Claude)</label>
                <textarea id="synthesis-prompt" rows="8" placeholder="Enter the prompt template for synthesizing multiple summaries..."></textarea>
                <small class="help-text">This prompt is used by Claude to synthesize the 4 individual summaries into one comprehensive summary. The 4 summaries will be appended to this prompt.</small>
                <div class="char-count">
                    <span id="synthesis-prompt-chars">0</span> characters
                </div>
            </div>
        </div>

        <button class="btn btn-primary" onclick="saveSettings()">
            <i data-lucide="save"></i>
            <span>Save Settings</span>
        </button>
    </div>

    <!-- Tab: User Management -->
    <div id="users" class="tab-content">
        <!-- Registration Mode Selector -->
        <div class="section-card">
            <h2><i data-lucide="settings"></i> Registration Mode</h2>
            <p class="help-text">Control who can register and request login PINs.</p>

            <div class="form-group">
                <div class="context-mode-toggle-container">
                    <div class="context-mode-option" id="mode-invite-only">
                        <div class="mode-icon"><i data-lucide="lock"></i></div>
                        <div class="mode-details">
                            <strong>Invite Only</strong>
                            <span>Secure and controlled. (Only invited emails can request PINs)</span>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="registration-mode-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <div class="context-mode-option" id="mode-open-registration">
                        <div class="mode-icon"><i data-lucide="unlock"></i></div>
                        <div class="mode-details">
                            <strong>Open Registration</strong>
                            <span>Public and open. (Any valid email can request a PIN and register)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload CSV Section -->
        <div class="section-card">
            <h2><i data-lucide="upload"></i> Upload Users</h2>
            <p class="help-text">Upload a CSV file with email addresses to create invites in bulk.</p>

            <div class="upload-csv-section">
                <input type="file" id="user-csv-input" accept=".csv" hidden>
                <button class="btn btn-secondary" onclick="document.getElementById('user-csv-input').click()">
                    <i data-lucide="upload"></i>
                    <span>Choose CSV File</span>
                </button>
                <div class="csv-format-hint">
                    <strong>CSV Format:</strong>
                    <code>One email per line</code>
                    <small>Names are auto-generated from email addresses (e.g., john.doe@example.com â†’ John Doe).</small>
                </div>
            </div>
        </div>

        <!-- Users List Section -->
        <div class="section-card">
            <div class="section-header-with-actions">
                <h2><i data-lucide="users"></i> Invited Users</h2>
                <button class="btn btn-primary" onclick="sendBulkInvites()">
                    <i data-lucide="mail"></i>
                    <span>Send All Pending Invites</span>
                </button>
            </div>

            <div id="users-list" class="users-list">
                <div class="loading-state">
                    <i data-lucide="loader"></i>
                    <p>Loading users...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin.js') }}?v={{ cache_buster }}"></script>
<script>
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
    }
</script>
{% endblock %}
